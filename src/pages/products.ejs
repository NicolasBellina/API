<!DOCTYPE html>
<html lang="fr" class="h-100">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Produits</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      main {
        flex: 1;
      }
    </style>
  </head>

  <body
    class="d-flex flex-column h-100 <%= locals.isAdmin ? 'bg-dark text-white' : '' %>"
  >
    <%- include('../components/header') %>

    <main class="flex-shrink-0">
      <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h1>Nos produits</h1>
          <button class="btn btn-success" onclick="ajouterProduit()">
            <i class="fas fa-plus"></i> Ajouter un produit
          </button>
        </div>
        <div id="products-container" class="row">
          <!-- Les produits seront affichés ici -->
        </div>
      </div>
    </main>

    <%- include('../components/footer') %>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Fonction pour charger les produits
      async function loadProducts() {
        try {
          const response = await fetch("/api/products", {
            headers: {
              Accept: "application/json",
            },
          });

          if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
          }

          const result = await response.json();
          const products = result.data; // Accéder au tableau de produits dans la propriété data
          const container = document.getElementById("products-container");
          container.innerHTML = ""; // Nettoyer le conteneur

          if (!products || products.length === 0) {
            container.innerHTML =
              '<div class="alert alert-info">Aucun produit disponible</div>';
            return;
          }

          const isDarkMode = document.body.classList.contains("bg-dark");

          products.forEach((product) => {
            const productCard = `
                        <div class="col-md-4 mb-4">
                            <div class="card h-100 ${
                              isDarkMode ? "bg-dark text-white" : ""
                            } border-primary">
                                <div class="card-body">
                                    <h5 class="card-title">${product.nom}</h5>
                                    <p class="card-text">${
                                      product.description ||
                                      "Aucune description"
                                    }</p>
                                    <div class="mt-3">
                                        <p class="mb-2">
                                            <span class="badge bg-primary">Prix: ${
                                              product.prix
                                            } €</span>
                                            <span class="badge bg-secondary">Stock: ${
                                              product.quantite_stock
                                            }</span>
                                        </p>
                                        <p class="mb-2">
                                            <span class="badge bg-info">Type: ${
                                              product.type_produit || "N/A"
                                            }</span>
                                            <span class="badge bg-info">Taille: ${
                                              product.taille_id || "N/A"
                                            }</span>
                                        </p>
                                        <p class="mb-2">
                                            <span class="badge bg-info">Couleur: ${
                                              product.couleur_id || "N/A"
                                            }</span>
                                            <span class="badge bg-info">Marque: ${
                                              product.marque_id || "N/A"
                                            }</span>
                                        </p>
                                    </div>
                                    <div class="mt-3 d-flex gap-2 justify-content-between">
                                        <button class="btn btn-outline-primary" onclick="voirDetails(${
                                          product.id_produit
                                        })">
                                            <i class="fas fa-eye"></i> Voir
                                        </button>
                                        <button class="btn btn-warning" onclick="modifierProduit(${
                                          product.id_produit
                                        })">
                                            <i class="fas fa-edit"></i> Modifier
                                        </button>
                                        <button class="btn btn-danger" onclick="supprimerProduit(${
                                          product.id_produit
                                        })">
                                            <i class="fas fa-trash"></i> Supprimer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
            container.insertAdjacentHTML("beforeend", productCard);
          });
        } catch (error) {
          console.error("Erreur:", error);
          const container = document.getElementById("products-container");
          container.innerHTML = '<div class="alert alert-danger">Erreur lors du chargement des produits</div>';
        }
      }

      // Fonction pour ajouter un produit
      async function ajouterProduit() {
        const modalHtml = `
                <div class="modal fade" id="addProductModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content ${
                          document.body.classList.contains("bg-dark")
                            ? "bg-dark text-white"
                            : ""
                        }">
                            <div class="modal-header">
                                <h5 class="modal-title">Ajouter un nouveau produit</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="addProductForm">
                                    <div class="mb-3">
                                        <label for="nom" class="form-label">Nom</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-box"></i>
                                            </span>
                                            <input type="text" class="form-control" id="nom" required>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="description" class="form-label">Description</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-align-left"></i>
                                            </span>
                                            <textarea class="form-control" id="description"></textarea>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="prix" class="form-label">Prix</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-euro-sign"></i>
                                            </span>
                                            <input type="number" class="form-control" id="prix" step="0.01" required>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="quantite_stock" class="form-label">Stock</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-warehouse"></i>
                                            </span>
                                            <input type="number" class="form-control" id="quantite_stock" required>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="type_produit" class="form-label">Type de produit</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-tags"></i>
                                            </span>
                                            <select class="form-select" id="type_produit" required>
                                                <option value="">Sélectionner une catégorie</option>
                                                <optgroup label="Vêtements">
                                                    <option value="1">T-shirt</option>
                                                    <option value="2">Pantalon</option>
                                                    <option value="3">Robe</option>
                                                    <option value="4">Pull</option>
                                                    <option value="5">Veste</option>
                                                    <option value="6">Chemise</option>
                                                    <option value="7">Jupe</option>
                                                    <option value="8">Short</option>
                                                </optgroup>
                                                <optgroup label="Chaussures">
                                                    <option value="9">Baskets</option>
                                                    <option value="10">Bottes</option>
                                                    <option value="11">Sandales</option>
                                                    <option value="12">Escarpins</option>
                                                    <option value="13">Mocassins</option>
                                                </optgroup>
                                                <optgroup label="Accessoires">
                                                    <option value="14">Sac</option>
                                                    <option value="15">Ceinture</option>
                                                    <option value="16">Écharpe</option>
                                                    <option value="17">Bonnet</option>
                                                    <option value="18">Casquette</option>
                                                    <option value="19">Bijoux</option>
                                                </optgroup>
                                                <optgroup label="Sport">
                                                    <option value="20">Maillot de sport</option>
                                                    <option value="21">Legging</option>
                                                    <option value="22">Short de sport</option>
                                                    <option value="23">Survêtement</option>
                                                </optgroup>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="taille_id" class="form-label">Taille</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-ruler"></i>
                                            </span>
                                           <select class="form-select" id="taille_id" required>
                                                <option value="">Sélectionner une taille</option>
                                                <option value="XS">XS</option>
                                                <option value="S">S</option>
                                                <option value="M">M</option>
                                                <option value="L">L</option>
                                                <option value="XL">XL</option>
                                                <option value="XXL">XXL</option>
                                                <option value="XXXL">XXXL</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="couleur_id" class="form-label">Couleur</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-palette"></i>
                                            </span>
                                            <select class="form-select" id="couleur_id" required>
                                                <option value="">Sélectionner une couleur</option>
                                                <option value="Noir">Noir</option>
                                                <option value="Blanc">Blanc</option>
                                                <option value="Rouge">Rouge</option>
                                                <option value="Bleu">Bleu</option>
                                                <option value="Vert">Vert</option>
                                                <option value="Gris">Gris</option>
                                                <option value="Beige">Beige</option>
                                                <option value="Marine">Marine</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="marque_id" class="form-label">Marque</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-trademark"></i>
                                            </span>
                                            <select class="form-select" id="marque_id" required>
                                                <option value="">Sélectionner une marque</option>
                                                <optgroup label="Marques de luxe">
                                                    <option value="Ralph Lauren">Ralph Lauren</option>
                                                    <option value="Tommy Hilfiger">Tommy Hilfiger</option>
                                                    <option value="Lacoste">Lacoste</option>
                                                    <option value="Calvin Klein">Calvin Klein</option>
                                                </optgroup>
                                                <optgroup label="Marques sportives">
                                                    <option value="Nike">Nike</option>
                                                    <option value="Adidas">Adidas</option>
                                                    <option value="Puma">Puma</option>
                                                    <option value="Under Armour">Under Armour</option>
                                                </optgroup>
                                                <optgroup label="Fast Fashion">
                                                    <option value="Zara">Zara</option>
                                                    <option value="H&M">H&M</option>
                                                </optgroup>
                                            </select>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                                <button type="button" class="btn btn-primary" onclick="soumettreNouveauProduit()">
                                </i> Ajouter
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

        document.body.insertAdjacentHTML("beforeend", modalHtml);
        const modal = new bootstrap.Modal(
          document.getElementById("addProductModal")
        );
        modal.show();
      }

      // Fonction pour soumettre un nouveau produit
      async function soumettreNouveauProduit() {
        try {
          // Récupération et validation des champs
          const nom = document.getElementById("nom").value.trim();
          const prix = parseFloat(document.getElementById("prix").value);
          const quantite_stock = parseInt(document.getElementById("quantite_stock").value);
          const type_produit = parseInt(document.getElementById("type_produit").value);

          // Validation des champs obligatoires
          if (!nom) {
            throw new Error('Le nom du produit est obligatoire');
          }
          if (isNaN(prix) || prix <= 0) {
            throw new Error('Le prix doit être un nombre positif');
          }
          if (isNaN(quantite_stock) || quantite_stock < 0) {
            throw new Error('La quantité en stock doit être un nombre positif ou nul');
          }
          if (isNaN(type_produit) || type_produit <= 0) {
            throw new Error('Le type de produit doit être sélectionné');
          }

          const formData = {
            nom,
            description: document.getElementById("description").value.trim(),
            prix,
            quantite_stock,
            type_produit,
            taille_id: document.getElementById("taille_id").value || null,
            couleur_id: document.getElementById("couleur_id").value || null,
            marque_id: document.getElementById("marque_id").value || null,
          };

          console.log('Données à envoyer:', formData);

          const response = await fetch("/api/products", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(formData),
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.message || `Erreur HTTP: ${response.status}`);
          }

          // Fermer et supprimer le modal
          const modal = bootstrap.Modal.getInstance(document.getElementById("addProductModal"));
          if (modal) {
            modal.hide();
            document.getElementById("addProductModal").remove();
          }

          // Recharger la liste des produits
          await loadProducts();

          // Afficher le message de succès
          const alertHtml = `
            <div class="alert alert-success alert-dismissible fade show" role="alert">
              Produit ajouté avec succès
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          `;
          document.querySelector('.container').insertAdjacentHTML('afterbegin', alertHtml);

          // Supprimer l'alerte après 3 secondes
          setTimeout(() => {
            const alert = document.querySelector('.alert');
            if (alert) {
              alert.remove();
            }
          }, 3000);

        } catch (error) {
          console.error("Erreur:", error);
          const alertHtml = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              ${error.message}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          `;
          document.querySelector('.container').insertAdjacentHTML('afterbegin', alertHtml);
        }
      }

      // Fonction pour modifier un produit
      async function modifierProduit(id) {
        try {
          const response = await fetch(`/api/products/${id}`, {
            headers: {
              Accept: "application/json",
            },
          });

          if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
          }

          const result = await response.json();
          const product = result.data; // Accéder aux données du produit dans la propriété data

          if (!product) {
            throw new Error('Produit non trouvé');
          }

          const modalHtml = `
                    <div class="modal fade" id="editProductModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content ${
                              document.body.classList.contains("bg-dark")
                                ? "bg-dark text-white"
                                : ""
                            }">
                                <div class="modal-header">
                                    <h5 class="modal-title">Modifier le produit</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="editProductForm">
                                        <div class="mb-3">
                                            <label for="edit_nom" class="form-label">Nom</label>
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i class="fas fa-box"></i>
                                                </span>
                                                <input type="text" class="form-control" id="edit_nom" value="${
                                                  product.nom
                                                }" required>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="edit_description" class="form-label">Description</label>
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i class="fas fa-align-left"></i>
                                                </span>
                                                <textarea class="form-control" id="edit_description">${
                                                  product.description || ""
                                                }</textarea>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="edit_prix" class="form-label">Prix</label>
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i class="fas fa-euro-sign"></i>
                                                </span>
                                                <input type="number" class="form-control" id="edit_prix" step="0.01" value="${
                                                  product.prix
                                                }" required>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="edit_quantite_stock" class="form-label">Stock</label>
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i class="fas fa-warehouse"></i>
                                                </span>
                                                <input type="number" class="form-control" id="edit_quantite_stock" value="${
                                                  product.quantite_stock
                                                }" required>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="edit_type_produit" class="form-label">Type de produit</label>
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i class="fas fa-tags"></i>
                                                </span>
                                                <select class="form-select" id="edit_type_produit" required>
                                                    <option value="">Sélectionner une catégorie</option>
                                                    <optgroup label="Vêtements">
                                                        <option value="1" ${
                                                          product.type_produit ===
                                                          "1"
                                                            ? "selected"
                                                            : ""
                                                        }>T-shirt</option>
                                                        <option value="2" ${
                                                          product.type_produit ===
                                                          "2"
                                                            ? "selected"
                                                            : ""
                                                        }>Pantalon</option>
                                                        <option value="3" ${
                                                          product.type_produit ===
                                                          "3"
                                                            ? "selected"
                                                            : ""
                                                        }>Robe</option>
                                                        <option value="4" ${
                                                          product.type_produit ===
                                                          "4"
                                                            ? "selected"
                                                            : ""
                                                        }>Pull</option>
                                                        <option value="5" ${
                                                          product.type_produit ===
                                                          "5"
                                                            ? "selected"
                                                            : ""
                                                        }>Veste</option>
                                                        <option value="6" ${
                                                          product.type_produit ===
                                                          "6"
                                                            ? "selected"
                                                            : ""
                                                        }>Chemise</option>
                                                        <option value="7" ${
                                                          product.type_produit ===
                                                          "7"
                                                            ? "selected"
                                                            : ""
                                                        }>Jupe</option>
                                                        <option value="8" ${
                                                          product.type_produit ===
                                                          "8"
                                                            ? "selected"
                                                            : ""
                                                        }>Short</option>
                                                    </optgroup>
                                                    <optgroup label="Chaussures">
                                                        <option value="9" ${
                                                          product.type_produit ===
                                                          "9"
                                                            ? "selected"
                                                            : ""
                                                        }>Baskets</option>
                                                        <option value="10" ${
                                                          product.type_produit ===
                                                          "10"
                                                            ? "selected"
                                                            : ""
                                                        }>Bottes</option>
                                                        <option value="11" ${
                                                          product.type_produit ===
                                                          "11"
                                                            ? "selected"
                                                            : ""
                                                        }>Sandales</option>
                                                        <option value="12" ${
                                                          product.type_produit ===
                                                          "12"
                                                            ? "selected"
                                                            : ""
                                                        }>Escarpins</option>
                                                        <option value="13" ${
                                                          product.type_produit ===
                                                          "13"
                                                            ? "selected"
                                                            : ""
                                                        }>Mocassins</option>
                                                    </optgroup>
                                                    <optgroup label="Accessoires">
                                                        <option value="14" ${
                                                          product.type_produit ===
                                                          "14"
                                                            ? "selected"
                                                            : ""
                                                        }>Sac</option>
                                                        <option value="15" ${
                                                          product.type_produit ===
                                                          "15"
                                                            ? "selected"
                                                            : ""
                                                        }>Ceinture</option>
                                                        <option value="16" ${
                                                          product.type_produit ===
                                                          "16"
                                                            ? "selected"
                                                            : ""
                                                        }>Écharpe</option>
                                                        <option value="17" ${
                                                          product.type_produit ===
                                                          "17"
                                                            ? "selected"
                                                            : ""
                                                        }>Bonnet</option>
                                                        <option value="18" ${
                                                          product.type_produit ===
                                                          "18"
                                                            ? "selected"
                                                            : ""
                                                        }>Casquette</option>
                                                        <option value="19" ${
                                                          product.type_produit ===
                                                          "19"
                                                            ? "selected"
                                                            : ""
                                                        }>Bijoux</option>
                                                    </optgroup>
                                                    <optgroup label="Sport">
                                                        <option value="20" ${
                                                          product.type_produit ===
                                                          "20"
                                                            ? "selected"
                                                            : ""
                                                        }>Maillot de sport</option>
                                                        <option value="21" ${
                                                          product.type_produit ===
                                                          "21"
                                                            ? "selected"
                                                            : ""
                                                        }>Legging</option>
                                                        <option value="22" ${
                                                          product.type_produit ===
                                                          "22"
                                                            ? "selected"
                                                            : ""
                                                        }>Short de sport</option>
                                                        <option value="23" ${
                                                          product.type_produit ===
                                                          "23"
                                                            ? "selected"
                                                            : ""
                                                        }>Survêtement</option>
                                                    </optgroup>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="edit_taille_id" class="form-label">Taille</label>
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i class="fas fa-ruler"></i>
                                                </span>
                                                <select class="form-select" id="edit_taille_id" required>
                                                    <option value="">Sélectionner une taille</option>
                                                    <option value="XS" ${
                                                      product.taille_id === "XS"
                                                        ? "selected"
                                                        : ""
                                                    }>XS</option>
                                                    <option value="S" ${
                                                      product.taille_id === "S" ? "selected" : ""
                                                    }>S</option>
                                                    <option value="M" ${
                                                      product.taille_id === "M" ? "selected" : ""
                                                    }>M</option>
                                                    <option value="L" ${
                                                      product.taille_id === "L" ? "selected" : ""
                                                    }>L</option>
                                                    <option value="XL" ${
                                                      product.taille_id === "XL" ? "selected" : ""
                                                    }>XL</option>
                                                    <option value="XXL" ${
                                                      product.taille_id === "XXL" ? "selected" : ""
                                                    }>XXL</option>
                                                    <option value="XXXL" ${
                                                      product.taille_id === "XXXL" ? "selected" : ""
                                                    }>XXXL</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="edit_couleur_id" class="form-label">Couleur</label>
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i class="fas fa-palette"></i>
                                                </span>
                                                <select class="form-select" id="edit_couleur_id" required>
                                                    <option value="">Sélectionner une couleur</option>
                                                    <option value="Noir" ${
                                                      product.couleur_id ===
                                                      "Noir"
                                                        ? "selected"
                                                        : ""
                                                    }>Noir</option>
                                                    <option value="Blanc" ${
                                                      product.couleur_id ===
                                                      "Blanc"
                                                        ? "selected"
                                                        : ""
                                                    }>Blanc</option>
                                                    <option value="Rouge" ${
                                                      product.couleur_id ===
                                                      "Rouge"
                                                        ? "selected"
                                                        : ""
                                                    }>Rouge</option>
                                                    <option value="Bleu" ${
                                                      product.couleur_id ===
                                                      "Bleu"
                                                        ? "selected"
                                                        : ""
                                                    }>Bleu</option>
                                                    <option value="Vert" ${
                                                      product.couleur_id ===
                                                      "Vert"
                                                        ? "selected"
                                                        : ""
                                                    }>Vert</option>
                                                    <option value="Gris" ${
                                                      product.couleur_id ===
                                                      "Gris"
                                                        ? "selected"
                                                        : ""
                                                    }>Gris</option>
                                                    <option value="Beige" ${
                                                      product.couleur_id ===
                                                      "Beige"
                                                        ? "selected"
                                                        : ""
                                                    }>Beige</option>
                                                    <option value="Marine" ${
                                                      product.couleur_id ===
                                                      "Marine"
                                                        ? "selected"
                                                        : ""
                                                    }>Marine</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="edit_marque_id" class="form-label">Marque</label>
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i class="fas fa-trademark"></i>
                                                </span>
                                                <select class="form-select" id="edit_marque_id" required>
                                                    <option value="">Sélectionner une marque</option>
                                                    <optgroup label="Marques de luxe">
                                                        <option value="Ralph Lauren" ${
                                                          product.marque_id ===
                                                          "Ralph Lauren"
                                                            ? "selected"
                                                            : ""
                                                        }>Ralph Lauren</option>
                                                        <option value="Tommy Hilfiger" ${
                                                          product.marque_id ===
                                                          "Tommy Hilfiger"
                                                            ? "selected"
                                                            : ""
                                                        }>Tommy Hilfiger</option>
                                                        <option value="Lacoste" ${
                                                          product.marque_id ===
                                                          "Lacoste"
                                                            ? "selected"
                                                            : ""
                                                        }>Lacoste</option>
                                                        <option value="Calvin Klein" ${
                                                          product.marque_id ===
                                                          "Calvin Klein"
                                                            ? "selected"
                                                            : ""
                                                        }>Calvin Klein</option>
                                                    </optgroup>
                                                    <optgroup label="Marques sportives">
                                                        <option value="Nike" ${
                                                          product.marque_id ===
                                                          "Nike"
                                                            ? "selected"
                                                            : ""
                                                        }>Nike</option>
                                                        <option value="Adidas" ${
                                                          product.marque_id ===
                                                          "Adidas"
                                                            ? "selected"
                                                            : ""
                                                        }>Adidas</option>
                                                        <option value="Puma" ${
                                                          product.marque_id ===
                                                          "Puma"
                                                            ? "selected"
                                                            : ""
                                                        }>Puma</option>
                                                        <option value="Under Armour" ${
                                                          product.marque_id ===
                                                          "Under Armour"
                                                            ? "selected"
                                                            : ""
                                                        }>Under Armour</option>
                                                    </optgroup>
                                                    <optgroup label="Fast Fashion">
                                                        <option value="Zara" ${
                                                          product.marque_id ===
                                                          "Zara"
                                                            ? "selected"
                                                            : ""
                                                        }>Zara</option>
                                                        <option value="H&M" ${
                                                          product.marque_id ===
                                                          "H&M"
                                                            ? "selected"
                                                            : ""
                                                        }>H&M</option>
                                                    </optgroup>
                                                </select>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                                    <button type="button" class="btn btn-primary" onclick="soumettreModificationProduit(${product.id_produit})">
                                        <i class="fas fa-save"></i> Enregistrer
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

          const oldModal = document.getElementById("editProductModal");
          if (oldModal) oldModal.remove();

          document.body.insertAdjacentHTML("beforeend", modalHtml);
          const modal = new bootstrap.Modal(
            document.getElementById("editProductModal")
          );
          modal.show();
        } catch (error) {
          console.error("Erreur:", error);
          const alertHtml = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              Erreur lors de la récupération des données du produit: ${error.message}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          `;
          document.querySelector('.container').insertAdjacentHTML('afterbegin', alertHtml);
        }
      }

      // Fonction pour soumettre la modification d'un produit
      async function soumettreModificationProduit(id) {
        try {
          // Récupérer et valider les données du formulaire
          const nom = document.getElementById("edit_nom").value.trim();
          const prix = parseFloat(document.getElementById("edit_prix").value);
          const quantite_stock = parseInt(document.getElementById("edit_quantite_stock").value);
          const type_produit = parseInt(document.getElementById("edit_type_produit").value);

          // Validation des champs obligatoires
          if (!nom) {
            throw new Error('Le nom du produit est obligatoire');
          }
          if (isNaN(prix) || prix <= 0) {
            throw new Error('Le prix doit être un nombre positif');
          }
          if (isNaN(quantite_stock) || quantite_stock < 0) {
            throw new Error('La quantité en stock doit être un nombre positif ou nul');
          }
          if (isNaN(type_produit) || type_produit <= 0) {
            throw new Error('Le type de produit doit être sélectionné');
          }

          const formData = {
            nom,
            description: document.getElementById("edit_description").value.trim(),
            prix,
            quantite_stock,
            type_produit,
            taille_id: document.getElementById("edit_taille_id").value || null,
            couleur_id: document.getElementById("edit_couleur_id").value || null,
            marque_id: document.getElementById("edit_marque_id").value || null,
          };

          console.log('Données à envoyer:', formData);

          const response = await fetch(`/api/products/${id}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(formData),
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.message || `Erreur HTTP: ${response.status}`);
          }

          // Fermer le modal
          const modal = bootstrap.Modal.getInstance(
            document.getElementById("editProductModal")
          );
          if (modal) {
            modal.hide();
            document.getElementById("editProductModal").remove();
          }

          // Recharger la liste des produits
          await loadProducts();

          // Afficher le message de succès
          const alertHtml = `
            <div class="alert alert-success alert-dismissible fade show" role="alert">
              Produit modifié avec succès
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          `;
          document.querySelector('.container').insertAdjacentHTML('afterbegin', alertHtml);

          // Supprimer l'alerte après 3 secondes
          setTimeout(() => {
            const alert = document.querySelector('.alert');
            if (alert) {
              alert.remove();
            }
          }, 3000);
        } catch (error) {
          console.error("Erreur:", error);
          const alertHtml = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              ${error.message}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          `;
          document.querySelector('.container').insertAdjacentHTML('afterbegin', alertHtml);
        }
      }

      // Fonction pour voir les détails d'un produit
      async function voirDetails(id) {
        try {
          const response = await fetch(`/api/products/${id}`, {
            headers: {
              Accept: "application/json",
            },
          });

          if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
          }

          const result = await response.json();
          const product = result.data; // Accéder aux données du produit dans la propriété data

          if (!product) {
            throw new Error('Produit non trouvé');
          }

          const modalHtml = `
                    <div class="modal fade" id="productModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content ${
                              document.body.classList.contains("bg-dark")
                                ? "bg-dark text-white"
                                : ""
                            }">
                                <div class="modal-header">
                                    <h5 class="modal-title">Détails du produit: ${
                                      product.nom
                                    }</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="card ${
                                      document.body.classList.contains(
                                        "bg-dark"
                                      )
                                        ? "bg-dark text-white"
                                        : ""
                                    } border-primary">
                                        <div class="card-body">
                                            <h6 class="card-subtitle mb-3 text-muted">Informations générales</h6>
                                            <p><strong>Nom:</strong> ${
                                              product.nom
                                            }</p>
                                            <p><strong>Description:</strong> ${
                                              product.description ||
                                              "Aucune description"
                                            }</p>
                                            <p><strong>Prix:</strong> ${
                                              typeof product.prix === 'number' 
                                              ? product.prix.toLocaleString("fr-FR")
                                              : product.prix
                                            } €</p>
                                            <p><strong>Stock:</strong> ${
                                              product.quantite_stock
                                            }</p>
                                            
                                            <h6 class="card-subtitle mb-3 mt-4 text-muted">Caractéristiques</h6>
                                            <p><strong>Type:</strong> ${
                                              product.type_produit || "N/A"
                                            }</p>
                                            <p><strong>Taille:</strong> ${
                                              product.taille_id || "N/A"
                                            }</p>
                                            <p><strong>Couleur:</strong> ${
                                              product.couleur_id || "N/A"
                                            }</p>
                                            <p><strong>Marque:</strong> ${
                                              product.marque_id || "N/A"
                                            }</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                                    <button type="button" class="btn btn-primary" onclick="modifierProduit(${
                                      product.id_produit
                                    })">
                                        <i class="fas fa-edit"></i> Modifier
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

          // Supprimer l'ancien modal s'il existe
          const oldModal = document.getElementById("productModal");
          if (oldModal) oldModal.remove();

          // Ajouter le nouveau modal
          document.body.insertAdjacentHTML("beforeend", modalHtml);
          
          // Afficher le modal
          const modal = new bootstrap.Modal(
            document.getElementById("productModal")
          );
          modal.show();
        } catch (error) {
          console.error("Erreur:", error);
          alert(`Erreur lors de la récupération des détails du produit: ${error.message}`);
        }
      }

      // Fonction pour supprimer un produit
      async function supprimerProduit(id) {
        if (confirm("Êtes-vous sûr de vouloir supprimer ce produit ?")) {
          try {
            const response = await fetch(`/api/products/${id}`, {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json"
              }
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.message || `Erreur HTTP: ${response.status}`);
            }

            // Afficher le message de succès
            const alertHtml = `
              <div class="alert alert-success alert-dismissible fade show" role="alert">
                ${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            `;
            document.querySelector('.container').insertAdjacentHTML('afterbegin', alertHtml);

            // Recharger la liste des produits
            await loadProducts();

            // Supprimer l'alerte après 3 secondes
            setTimeout(() => {
              const alert = document.querySelector('.alert');
              if (alert) {
                alert.remove();
              }
            }, 3000);
          } catch (error) {
            console.error("Erreur:", error);
            const alertHtml = `
              <div class="alert alert-danger alert-dismissible fade show" role="alert">
                ${error.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            `;
            document.querySelector('.container').insertAdjacentHTML('afterbegin', alertHtml);
          }
        }
      }

      // Charger les produits au chargement de la page
      window.addEventListener("load", loadProducts);
    </script>
  </body>
</html>
